name: Reusable • Arduino Build (single job)

on:
  workflow_call:
    inputs:
      fqbn_json:
        description: 'JSON com FQBN(s). Ex.: ["esp32:esp32:esp32"] (usaremos o 1º)'
        required: true
        type: string

      sketches_glob:
        description: 'Globs para achar .ino (separe por vírgula). Default: "*.ino"'
        required: false
        type: string
        default: "*.ino"

      esp32_core_version:
        description: "Versão do core ESP32 (sempre explícita). Default: 3.3.2"
        required: false
        type: string
        default: "3.3.2"

      esp8266_core_version:
        description: "Versão do core ESP8266 (sempre explícita). Default: 3.1.2"
        required: false
        type: string
        default: "3.1.2"

      arduino_libs:
        description: "Bibliotecas adicionais (uma por linha; pode usar @versão)"
        required: false
        type: string
        default: ""

      extra_build_flags:
        description: "Flags extras do compilador (ex.: -DDEBUG=1)"
        required: false
        type: string
        default: ""

      board_options:
        description: 'Opções do board (ex.: "build.partitions=min_spiffs")'
        required: false
        type: string
        default: ""

      upload_artifacts:
        description: "Enviar firmware.bin como artefato"
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SKETCHES_GLOB: ${{ inputs.sketches_glob }}
      EXTRA_BUILD_FLAGS: ${{ inputs.extra_build_flags }}
      BOARD_OPTIONS: ${{ inputs.board_options }}

    steps:
      # --------------------------------------------------------------------
      # CHECKOUT
      # --------------------------------------------------------------------
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # --------------------------------------------------------------------
      # CACHE ARDUINO (CORES + LIBRARIES)
      # --------------------------------------------------------------------
      - name: Cache Arduino cores e bibliotecas
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: >
            arduino-${{ runner.os }}-${{ inputs.esp32_core_version }}-${{ inputs.esp8266_core_version }}-v1
          restore-keys: |
            arduino-${{ runner.os }}-${{ inputs.esp32_core_version }}-
            arduino-${{ runner.os }}-

      # --------------------------------------------------------------------
      # INSTALAR ARDUINO CLI (SEM ACTION EXTERNA)
      # --------------------------------------------------------------------
      - name: Instalar Arduino CLI
        shell: bash
        run: |
          set -euo pipefail

          echo "Baixando arduino-cli binário oficial (linux 64)..."
          URL="https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz"

          curl -fsSL "$URL" -o /tmp/arduino-cli.tar.gz
          tar -xzf /tmp/arduino-cli.tar.gz -C /tmp

          mkdir -p "$HOME/bin"
          mv /tmp/arduino-cli "$HOME/bin/arduino-cli"
          chmod +x "$HOME/bin/arduino-cli"

          export PATH="$HOME/bin:$PATH"
          echo "$HOME/bin" >> "$GITHUB_PATH"

          echo "Versão instalada:"
          arduino-cli version

      # --------------------------------------------------------------------
      # BOARD MANAGER URLs
      # --------------------------------------------------------------------
      - name: Configurar Board Manager URLs
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli config init || true
          arduino-cli config delete board_manager.additional_urls || true
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli config add board_manager.additional_urls https://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli config dump
          arduino-cli core update-index
          arduino-cli lib update-index

      # --------------------------------------------------------------------
      # SELECT FQBN
      # --------------------------------------------------------------------
      - name: Selecionar FQBN (1º item da lista JSON)
        id: fqbn
        shell: python3 {0}
        run: |
          import json
          data = json.loads("""${{ inputs.fqbn_json }}""")
          if not isinstance(data, list) or not data:
            raise SystemExit("fqbn_json precisa ser uma lista não-vazia")
          fqbn = data[0]
          print(f"FQBN selecionado: {fqbn}")
          open("/tmp/fqbn.txt","w").write(fqbn)

      # --------------------------------------------------------------------
      # INSTALL CORES (SEMPRE COM VERSÃO EXPLÍCITA)
      # --------------------------------------------------------------------
      - name: Instalar core do board
        shell: bash
        run: |
          set -euo pipefail
          FQBN="$(cat /tmp/fqbn.txt)"
          arduino-cli core update-index

          case "$FQBN" in
            esp32:esp32:*)
              echo "Instalando core ESP32 versão '${{ inputs.esp32_core_version }}'"
              arduino-cli core install "esp32:esp32@${{ inputs.esp32_core_version }}" || true
              ;;
            esp8266:esp8266:*)
              echo "Instalando core ESP8266 versão '${{ inputs.esp8266_core_version }}'"
              arduino-cli core install "esp8266:esp8266@${{ inputs.esp8266_core_version }}" || true
              ;;
            *)
              echo "FQBN desconhecido: $FQBN"
              exit 1
              ;;
          esac

          echo "=== Cores instalados ==="
          arduino-cli core list

      # --------------------------------------------------------------------
      # INSTALL LIBRARIES (GLOBAL + EXTRA) — SEM PCF8574 AQUI
      # --------------------------------------------------------------------
      - name: Instalar bibliotecas (globais + extras)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/Arduino/libraries

          echo "=== Montando lista de bibliotecas ==="

          BASE_LIBS=$(cat << 'EOF'
          LiquidCrystal I2C
          AsyncMqttClient
          ESPAsyncWebServer
          AsyncTCP
          ArduinoJson@7.1.0
          OneWire
          DallasTemperature
          EOF
          )

          EXTRA_LIBS="${{ inputs.arduino_libs }}"
          ALL_LIBS=$(printf "%s\n%s\n" "$BASE_LIBS" "$EXTRA_LIBS")

          echo "=== Bibliotecas a instalar ==="
          echo "$ALL_LIBS" | awk 'NF'

          echo "$ALL_LIBS" | awk 'NF' | while read -r raw; do
            lib="$(echo "$raw" | tr -d '\r' | xargs)"
            [ -z "$lib" ] && continue

            name="${lib%@*}"
            ver="${lib#*@}"; [ "$ver" = "$name" ] && ver=""
            lname="$(echo "$name" | tr '[:upper:]' '[:lower:]')"

            echo "-----------------------------"
            echo "Instalando '$lib'"

            # Se já existe como pasta em ~/Arduino/libraries, NÃO reinstala (cache-friendly)
            if [ -d "$HOME/Arduino/libraries/$name" ]; then
              echo "✅ Já existe em cache: ~/Arduino/libraries/$name (pulando instalação)"
              continue
            fi

            ok=false

            # Tentativas via Library Manager
            if arduino-cli lib install "$lib"; then ok=true; fi
            if [ "$ok" = false ] && [ -n "$ver" ]; then arduino-cli lib install "$name@$ver" && ok=true || true; fi
            if [ "$ok" = false ]; then arduino-cli lib install "$name" && ok=true || true; fi

            # Alias com "_" -> " "
            if [ "$ok" = false ]; then
              alt="$(echo "$name" | sed 's/_/ /g')"
              if [ "$alt" != "$name" ]; then
                arduino-cli lib install "$alt${ver:+@$ver}" && ok=true || true
              fi
            fi

            # Fallbacks GitHub específicos (clona em pasta temporária única)
            if [ "$ok" = false ]; then
              tmp="$(mktemp -d)"
              case "$lname" in
                asyncmqttclient)
                  echo "→ Fallback GitHub: AsyncMqttClient"
                  git clone --depth 1 https://github.com/marvinroger/async-mqtt-client.git "$tmp/AsyncMqttClient"
                  cp -r "$tmp/AsyncMqttClient" ~/Arduino/libraries/AsyncMqttClient
                  ok=true
                  ;;
                espasyncwebserver)
                  echo "→ Fallback GitHub: ESPAsyncWebServer (ESP32Async)"
                  git clone --depth 1 https://github.com/ESP32Async/ESPAsyncWebServer.git "$tmp/ESPAsyncWebServer"
                  cp -r "$tmp/ESPAsyncWebServer" ~/Arduino/libraries/ESPAsyncWebServer
                  ok=true
                  ;;
                asynctcp)
                  echo "→ Fallback GitHub: AsyncTCP"
                  git clone --depth 1 https://github.com/ESP32Async/AsyncTCP.git "$tmp/AsyncTCP" || \
                  git clone --depth 1 https://github.com/me-no-dev/AsyncTCP.git "$tmp/AsyncTCP"
                  cp -r "$tmp/AsyncTCP" ~/Arduino/libraries/AsyncTCP
                  ok=true
                  ;;
              esac
              rm -rf "$tmp" || true
            fi

            if [ "$ok" = false ]; then
              echo "❌ Não foi possível instalar '$lib'"
              exit 1
            fi

            echo "✅ OK: $lib"
          done

      # --------------------------------------------------------------------
      # INSTALAR/REUSAR PCF8574 (XREEF) SEMPRE (cache-friendly)
      # --------------------------------------------------------------------
      - name: Forçar PCF8574 (Renzo/xreef) — cache-friendly
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/Arduino/libraries

          LIBDIR="$HOME/Arduino/libraries/PCF8574"
          WANT_REMOTE="https://github.com/xreef/PCF8574_library.git"

          is_xreef=false
          if [ -d "$LIBDIR/.git" ]; then
            cur="$(git -C "$LIBDIR" remote get-url origin 2>/dev/null || true)"
            if [ "$cur" = "$WANT_REMOTE" ]; then
              is_xreef=true
            fi
          else
            # heurística: library.properties contendo "xreef" ou "Renzo" (caso não seja git)
            if [ -f "$LIBDIR/library.properties" ] && grep -qiE 'xreef|Renzo' "$LIBDIR/library.properties"; then
              is_xreef=true
            fi
          fi

          if [ "$is_xreef" = true ]; then
            echo "✅ PCF8574 já é xreef (reutilizando cache): $LIBDIR"
            exit 0
          fi

          echo "→ Instalando PCF8574_library (Renzo Mischianti / xreef)"
          rm -rf "$LIBDIR" || true

          tmp="$(mktemp -d)"
          git clone --depth 1 "$WANT_REMOTE" "$tmp/PCF8574"
          cp -r "$tmp/PCF8574" "$LIBDIR"
          rm -rf "$tmp" || true

          echo "Conteúdo da pasta PCF8574:"
          ls -R "$LIBDIR" || true

      # --------------------------------------------------------------------
      # FIX FORKS (ESP32/ESP8266) — cache-friendly
      # --------------------------------------------------------------------
      - name: Fixar forks corretos (ESP32 vs ESP8266) — cache-friendly
        shell: bash
        run: |
          set -euo pipefail
          FQBN="$(cat /tmp/fqbn.txt)"
          mkdir -p ~/Arduino/libraries

          ensure_repo() {
            local name="$1"
            local want_url="$2"
            local want_alt="$3"   # opcional
            local dest="$HOME/Arduino/libraries/$name"

            # se já existe e é git com remote correto -> reutiliza
            if [ -d "$dest/.git" ]; then
              cur="$(git -C "$dest" remote get-url origin 2>/dev/null || true)"
              if [ "$cur" = "$want_url" ] || { [ -n "$want_alt" ] && [ "$cur" = "$want_alt" ]; }; then
                echo "✅ Reutilizando cache: $name (origin=$cur)"
                return 0
              fi
              echo "⚠️ $name existe, mas origin=$cur (esperado $want_url). Reinstalando fork correto..."
              rm -rf "$dest" || true
            elif [ -d "$dest" ]; then
              echo "⚠️ $name existe mas não é git repo (pasta). Reinstalando fork correto..."
              rm -rf "$dest" || true
            fi

            tmp="$(mktemp -d)"
            echo "→ Clonando $name: $want_url"
            git clone --depth 1 "$want_url" "$tmp/$name" || {
              if [ -n "$want_alt" ]; then
                echo "→ Clone falhou, tentando alternativa: $want_alt"
                git clone --depth 1 "$want_alt" "$tmp/$name"
              else
                exit 1
              fi
            }
            cp -r "$tmp/$name" "$dest"
            rm -rf "$tmp" || true
          }

          if echo "$FQBN" | grep -qi '^esp32:esp32:'; then
            echo "→ ESP32: garantindo forks ESP32Async"
            ensure_repo "AsyncTCP" "https://github.com/ESP32Async/AsyncTCP.git" ""
            ensure_repo "ESPAsyncWebServer" "https://github.com/ESP32Async/ESPAsyncWebServer.git" ""
          elif echo "$FQBN" | grep -qi '^esp8266:esp8266:'; then
            echo "→ ESP8266: garantindo libs me-no-dev"
            ensure_repo "AsyncTCP" "https://github.com/me-no-dev/AsyncTCP.git" ""
            ensure_repo "ESPAsyncWebServer" "https://github.com/me-no-dev/ESPAsyncWebServer.git" ""
          else
            echo "→ FQBN não é ESP32 nem ESP8266; nenhum fork especial aplicado."
          fi

          echo "=== Bibliotecas instaladas ==="
          ls -1 ~/Arduino/libraries || true

      # --------------------------------------------------------------------
      # FIND .INO
      # --------------------------------------------------------------------
      - name: Localizar sketch (.ino)
        id: find-sketch
        shell: bash
        run: |
          set -euo pipefail

          IFS=',' read -ra GLOBS <<< "${SKETCHES_GLOB}"
          files=()

          for g in "${GLOBS[@]}"; do
            pat="$(echo "$g" | xargs)"
            [ -z "$pat" ] && continue
            while IFS= read -r -d '' f; do
              files+=("${f#./}")
            done < <(find . -path "./.git" -prune -o -type f -iname "$pat" -print0)
          done

          if [ ${#files[@]} -eq 0 ]; then
            echo "Nenhum .ino encontrado pelos globs: ${SKETCHES_GLOB}"
            exit 1
          fi

          echo "SKETCH=${files[0]}" >> "$GITHUB_OUTPUT"
          echo "Sketch selecionado: ${files[0]}"

      # --------------------------------------------------------------------
      # BUILD
      # --------------------------------------------------------------------
      - name: Compilar firmware
        shell: bash
        run: |
          set -euo pipefail

          FQBN="$(cat /tmp/fqbn.txt)"
          SKETCH="${{ steps.find-sketch.outputs.SKETCH }}"
          DIR="$(dirname "$SKETCH")"

          BP=""
          if [ -n "$BOARD_OPTIONS" ]; then
            IFS=',' read -ra OPTS <<< "$BOARD_OPTIONS"
            for kv in "${OPTS[@]}"; do
              kv="$(echo "$kv" | xargs)"
              [ -z "$kv" ] && continue
              BP+=" --build-property ${kv}"
            done
          fi

          echo "Compilando: $SKETCH  (FQBN=$FQBN)"
          arduino-cli compile \
            --fqbn "$FQBN" \
            --build-property compiler.cpp.extra_flags="${EXTRA_BUILD_FLAGS}" \
            $BP \
            --export-binaries \
            "$DIR"

      # --------------------------------------------------------------------
      # COPY FIRMWARE
      # --------------------------------------------------------------------
      - name: Copiar firmware.bin para pasta /firmware
        shell: bash
        run: |
          set -euo pipefail
          SKETCH="${{ steps.find-sketch.outputs.SKETCH }}"
          DIR="$(dirname "$SKETCH")"
          BUILD="$DIR/build"
          TARGET="$(basename "$SKETCH" .ino)"

          BIN_ORIG="$(find "$BUILD" -type f -name "${TARGET}.ino.bin" | head -n 1)"
          DEST="$DIR/firmware"
          mkdir -p "$DEST"

          if [ -f "$BIN_ORIG" ]; then
            cp "$BIN_ORIG" "$DEST/firmware.bin"
            echo "✅ Firmware salvo em: $DEST/firmware.bin"
          else
            echo "❌ Não encontrei o firmware compilado!"
            echo "Arquivos .bin existentes:"
            find "$BUILD" -type f -name "*.bin" || true
            exit 1
          fi

      # --------------------------------------------------------------------
      # ARTIFACTS
      # --------------------------------------------------------------------
      - name: Publicar artefatos
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: |
            **/firmware/firmware.bin
            **/build/*/*.elf
          if-no-files-found: warn
